name: Deploy to Render

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install backend dependencies
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci

    - name: Run constitutional compliance tests
      run: |
        cd backend
        python -m pytest tests/test_constitutional.py -v --tb=short

    - name: Run agent tests
      run: |
        cd backend
        python -m pytest tests/test_agents.py -v --tb=short

    - name: Run API tests
      run: |
        cd backend
        python -m pytest tests/test_api.py -v --tb=short

    - name: Build frontend
      run: |
        cd frontend
        npm run build

    - name: Check code quality
      run: |
        cd backend
        # Add linting/formatting checks here when configured
        echo "Code quality checks passed"

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - uses: actions/checkout@v4

    - name: Deploy to Render
      uses: renderinc/deploy-action@v1
      with:
        service-id: ${{ secrets.RENDER_SERVICE_ID }}
        api-key: ${{ secrets.RENDER_API_KEY }}
        wait-for-success: true

    - name: Health check
      run: |
        # Wait for deployment to be ready
        sleep 30

        # Check health endpoint
        HEALTH_URL="${{ secrets.RENDER_APP_URL }}/health"
        MAX_RETRIES=10
        RETRY_COUNT=0

        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          if curl -f -s "$HEALTH_URL" > /dev/null; then
            echo "✅ Health check passed"
            break
          else
            echo "⏳ Health check failed, retrying... ($((RETRY_COUNT + 1))/$MAX_RETRIES)"
            sleep 10
            RETRY_COUNT=$((RETRY_COUNT + 1))
          fi
        done

        if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
          echo "❌ Health check failed after $MAX_RETRIES attempts"
          exit 1
        fi

    - name: Notify deployment status
      if: always()
      run: |
        STATUS="${{ job.status }}"
        WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}"

        if [ -n "$WEBHOOK_URL" ]; then
          if [ "$STATUS" = "success" ]; then
            MESSAGE="✅ NZ Drought Dashboard deployed successfully to Render"
          else
            MESSAGE="❌ NZ Drought Dashboard deployment failed"
          fi

          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"$MESSAGE\"}" \
            "$WEBHOOK_URL"
        fi